<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تأكيد الرمز</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h2>تأكيد الرمز</h2>

  <input type="text" id="otp" placeholder="أدخل رمز التحقق (6 أرقام)">
  <button onclick="verifyOTP()">تأكيد</button>

  <p class="msg" id="msg"></p>
</div>

  <script>
/* ==================  ================== */
const pendingPhone = localStorage.getItem("pending_phone");

if (!pendingPhone) {
  window.location.replace("auth.html");
}
</script>

<script>
/* ================== الإعدادات ================== */
const API = "https://script.google.com/macros/s/AKfycbxzkCyA7V3fcAZqT87mVLeGqFe5mi3XjQIMwIr3jA5OC0fhdsAlCvZZ-wiAFlg653v8/exec";

/* ================== فحص الصيانة ================== */
fetch(API)
  .then(r => r.json())
  .then(d => {
    if (d.maintenance === "ON") {
      window.location.replace("maintenance.html");
    }
  })
  .catch(() => {});

/* ================== حماية الصفحة ================== */
const phone = localStorage.getItem("phone");

/* إذا لا يوجد رقم هاتف → طرده */
if (!phone) {
  alert("يجب إدخال رقم الهاتف أولاً");
  window.location.replace("auth.html");
}

/* إذا كان متحقق مسبقاً → لا يعيد التحقق */
if (localStorage.getItem("auth_verified") === "yes") {
  window.location.replace("booking.html");
}

/* ================== التحقق من الرمز ================== */
function verifyOTP() {
  const otp = document.getElementById("otp").value.trim();
  const msg = document.getElementById("msg");

  msg.innerText = "";

  if (!/^\d{6}$/.test(otp)) {
    msg.innerText = "رمز التحقق يجب أن يكون 6 أرقام";
    return;
  }

  const fd = new FormData();
  fd.append("action", "verify_otp");
  fd.append("phone", phone);
  fd.append("otp", otp);

  fetch(API, { method: "POST", body: fd })
    .then(r => r.json())
    .then(d => {
      msg.innerText = d.message;

      if (d.status === "success") {
        /* ✅ ختم التحقق الحقيقي */
        localStorage.setItem("auth_verified", "yes");

        /* الدخول بعد التحقق فقط */
        window.location.replace("booking.html");
      }
    })
    .catch(() => {
      msg.innerText = "فشل الاتصال بالسيرفر";
    });
}
</script>
</body>
</html>
