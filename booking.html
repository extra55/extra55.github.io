<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ุญุฌุฒ ููุนุฏ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
<h2>ุญุฌุฒ ููุนุฏ ุทุจู</h2>

<label>ุงุฎุชุฑ ุงููุญุงูุธุฉ</label>
<select id="city" onchange="updateDoctors()">
<option value="">-- ุงุฎุชุฑ ุงููุญุงูุธุฉ --</option>
<option value="ุจุบุฏุงุฏ">ุจุบุฏุงุฏ</option>
<option value="ุฐู ูุงุฑ">ุฐู ูุงุฑ</option>
</select>

<label>ุงุณู ุงููุฑูุถ</label>
<input type="text" id="name">

<label>ุงุฎุชุฑ ุงูุงุฎุชุตุงุต</label>
<select id="specialty" onchange="filterDoctors()">
<option value="">-- ุงุฎุชุฑ ุงูุงุฎุชุตุงุต --</option>
</select>

<label>ุงุฎุชุฑ ุงูุทุจูุจ</label>
<select id="doctor" onchange="showAddress()">
<option value="">-- ุงุฎุชุฑ ุงูุทุจูุจ --</option>
</select>

<div id="addressBox" class="address-box" style="display:none;"></div>

<label>ุชุงุฑูุฎ ุงูุญุฌุฒ</label>
<input type="date" id="date">

<button onclick="book()">ุชุฃููุฏ ุงูุญุฌุฒ</button>
<button class="home-btn" onclick="goHome()">๐ ุงูุฑุฆูุณูุฉ</button>

<p id="msg"></p>
</div>

<script>
const API = "ุถุน_ุฑุงุจุท_ุงูุณูุฑูุจุช_ููุง";
let allDoctors = [];

// ุชุซุจูุช ุงููุญุงูุธุฉ
const savedCity = localStorage.getItem("city");
if (savedCity) {
  city.value = savedCity;
  updateDoctors();
}

function updateDoctors() {
  const cityVal = city.value;
  localStorage.setItem("city", cityVal);

  specialty.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุงุฎุชุตุงุต --</option>';
  doctor.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุทุจูุจ --</option>';
  addressBox.style.display = "none";

  if (!cityVal) return;

  const fd = new FormData();
  fd.append("action","get_doctors");
  fd.append("city",cityVal);

  fetch(API,{method:"POST",body:fd})
  .then(r=>r.json())
  .then(d=>{
    allDoctors = d.doctors;
    [...new Set(allDoctors.map(x=>x.specialty))].forEach(s=>{
      specialty.innerHTML += `<option>${s}</option>`;
    });
  });
}

function filterDoctors(){
  doctor.innerHTML='<option value="">-- ุงุฎุชุฑ ุงูุทุจูุจ --</option>';
  allDoctors.filter(d=>d.specialty===specialty.value)
  .forEach(d=>{
    const o=document.createElement("option");
    o.value=d.name;
    o.textContent=d.name;
    o.dataset.address=d.address;
    doctor.appendChild(o);
  });
}

function showAddress(){
  const o=doctor.options[doctor.selectedIndex];
  if(o?.dataset.address){
    addressBox.innerText="๐ "+o.dataset.address;
    addressBox.style.display="block";
  } else addressBox.style.display="none";
}

function book(){
  if(!city.value||!doctor.value||!name.value||!date.value){
    msg.innerText="ูุฑุฌู ููุก ุฌููุน ุงูุญููู";return;
  }

  const fd=new FormData();
  fd.append("action","booking");
  fd.append("city",city.value);
  fd.append("doctor_id",doctor.value);
  fd.append("patient_name",name.value);
  fd.append("phone",localStorage.getItem("phone"));
  fd.append("date",date.value);

  fetch(API,{method:"POST",body:fd})
  .then(r=>r.json())
  .then(d=>msg.innerText=d.message);
}

function goHome(){location.href="index.html";}
</script>

</body>
</html>
